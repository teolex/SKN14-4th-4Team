{% extends "app/base.html" %}
{% load static %}
{% block content %}

<h2 class="text-center mb-4">ğŸ’¬ GYM-PT ì±—ë´‡</h2>

{# â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒë‹¨ ì•¡ì…˜ ë²„íŠ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="d-flex justify-content-between mb-2">
  {# POST-REDIRECT-GET íŒ¨í„´ìš© ìƒˆë¡œê³ ì¹¨ ë§í¬ #}
  <a href="{% url 'chat' %}?reset=1" class="btn btn-outline-secondary">ìƒˆ ë©”ì‹œì§€</a>
</div>


{#----------------- ëŒ€í™” ì´ë ¥ -----------------#}
{% if chat_history %}
  <div class="mb-4">
    {% for role, content, images in chat_history %}
      <div class="alert {% if role == 'user' %}alert-primary text-dark{% else %}alert-secondary{% endif %}">
        <strong>
          {% if role == 'user' %}ğŸ‘¤ ì‚¬ìš©ì{% else %}ğŸ¤– GYM-PT{% endif %}
        </strong><br>
        {{ content|linebreaksbr }}

        {# ì²¨ë¶€ ì´ë¯¸ì§€ê°€ ìˆì„ ê²½ìš° ì¸ë„¤ì¼ í‘œì‹œ #}
        {% if images %}
          <div class="mt-2 d-flex flex-wrap gap-2">
            {% for img in images %}
              <img src="{{ img.url }}"
                   class="img-thumbnail"
                   style="max-width:120px; max-height:120px;"
                   alt="ì²¨ë¶€ ì´ë¯¸ì§€">
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% endif %}

{#----------------- ì…ë ¥ í¼ -----------------#}
<form method="post"
      enctype="multipart/form-data"
      action="{% url 'chat' %}"
      class="card p-4 mb-4">

  {% csrf_token %}

  {# â”€â”€â”€ ë©”ì‹œì§€ â”€â”€â”€ #}
  <div class="mb-3">
    <label for="id_message" class="form-label">ë©”ì‹œì§€:</label>
    <textarea id="id_message"
              name="message"
              rows="2"
              class="form-control"
              placeholder="ì˜ˆ: ì•„ì¹¨ì— ê³„ë€ ë‘ ê°œ ë¨¹ê³ â€¦"></textarea>
  </div>

  {# â”€â”€â”€ ì´ë¯¸ì§€ â”€â”€â”€ #}
  <div class="mb-3">
    <label for="{{ form.images.id_for_label }}" class="form-label">ìŒì‹ ì´ë¯¸ì§€ (ìµœëŒ€ 5ì¥):</label>
    <input
      type="file"
      id="id_images"
      name="images"
      accept=".jpg,.jpeg,.png"
      multiple
      class="form-control">
    <div class="form-text">jpg / png íŒŒì¼ì„ ìµœëŒ€ 5ì¥ê¹Œì§€ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>

    {% if form.images.errors %}
      <div class="text-danger small mt-1">{{ form.images.errors.0 }}</div>
    {% endif %}
    
    <div id="preview-box" class="d-flex flex-wrap gap-2 mt-2"></div>
  </div>

  <button type="submit"
        class="btn btn-success position-relative w-100"
        id="analyzeBtn">
    ğŸ“¤ ë¶„ì„ ìš”ì²­í•˜ê¸°
  </button>
</form>


{#----------------- ë‹¨ì¼ ì‘ë‹µ ì¹´ë“œ-----------------#}
{% if response %}
  <div class="card">
    <div class="card-body">
      <pre class="mb-0">{{ response }}</pre>
    </div>
  </div>
{% endif %}

{% endblock %}

