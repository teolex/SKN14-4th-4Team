{% extends '../layout/base_default.html' %}

{% load static %}

{% block title %}Gym-PT | Talk & Find!{% endblock title %}

{% block style %}
    <style>
        body {
            background-color: #f0f4f8;
            color: #212529;
        }
        .card {
            background-color: #ffffff;
            border: none;
            border-radius: 1rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }
        .btn-custom {
            background-color: white;
            border: 2px solid #198754;
            color: #198754;
            transition: all 0.3s ease;
        }
        .btn-custom:hover {
            background-color: #198754;
            color: white;
        }
        .form-control, .form-floating {
            background-color: #ffffff;
        }
        hr {
            border-top: 1px solid #dee2e6;
        }

        div.chatMsg { max-width:75%; }
        div#chatLogBox { max-height:500px; overflow-y:auto; }
    </style>
{% endblock style %}

{% block content %}
    <div class="container py-5">
        <!-- ìƒë‹¨ íƒ€ì´í‹€ ì¹´ë“œ -->
        <div class="card mb-4">
            <div class="card-body text-center">
                <p class="h2 text-success fw-bold">ğŸ’ª Gym-PTì™€ ëŒ€í™”í•˜ê¸°</p>
            </div>
        </div>

        <!-- ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
        <div class="mb-3">
            <a href="{% url 'mainapp:main' %}" class="btn btn-custom rounded-4">â† ë©”ì¸ìœ¼ë¡œ</a>
        </div>

        <hr/>

        <div class="container px-0 py-4">
            <div class="card shadow-sm" id="chagLogBox">
                <div class="card-body d-flex flex-column gap-3" id="chagLog">

                    <!-- ìƒëŒ€ë°© ë©”ì‹œì§€ -->
{#                    <div class="d-flex">#}
{#                        <div class="bg-light text-dark p-3 rounded-4" style="max-width: 75%;">#}
{#                            ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?#}
{#                        </div>#}
{#                    </div>#}
{##}
{#                    <!-- ì‚¬ìš©ì ë©”ì‹œì§€ -->#}
{#                    <div class="d-flex justify-content-end">#}
{#                        <div class="bg-success text-white p-3 rounded-4" style="max-width: 75%;">#}
{#                            ì•ˆë…•í•˜ì„¸ìš”, ì˜¤ëŠ˜ ë¨¹ì€ ìŒì‹ ë¶„ì„ ì¢€ ë¶€íƒí•´ìš”.#}
{#                        </div>#}
{#                    </div>#}
{##}
{#                    <!-- ìƒëŒ€ë°© ë©”ì‹œì§€ -->#}
{#                    <div class="d-flex">#}
{#                        <div class="bg-light text-dark p-3 rounded-4" style="max-width: 75%;">#}
{#                            ì‚¬ì§„ì´ë‚˜ í…ìŠ¤íŠ¸ë¥¼ ì˜¬ë ¤ì£¼ì‹œë©´ ë¶„ì„í•´ë“œë¦´ê²Œìš”!#}
{#                        </div>#}
{#                    </div>#}
{##}
{#                    <!-- ì‚¬ìš©ì ë©”ì‹œì§€ -->#}
{#                    <div class="d-flex justify-content-end">#}
{#                        <div class="bg-success text-white p-3 rounded-4" style="max-width: 75%;">#}
{#                            ì—¬ê¸° ê³„ë€ ì‚¬ì§„ì´ì—ìš”. ğŸ¥š#}
{#                        </div>#}
{#                    </div>#}

                </div>
            </div>
        </div>


        <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
        <form method="post" enctype="multipart/form-data" name="askForm">
            {% csrf_token %}
            <p class="h4 fw-bold mb-2">ğŸ“ ìƒˆë¡œìš´ ë©”ì‹œì§€</p>
            <p class="text-start">ìŒì‹ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš” (ìµœëŒ€ 5ê°œ).</p>
            <div class="mb-4">
                <label for="formFile" class="form-label text-secondary">ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ</label>
                <input class="form-control" type="file" id="formFile" multiple accept="jpg,jpeg,png" name="images">
            </div>

            <!-- ì¶”ê°€ ì •ë³´ -->
            <p class="text-start">ì‹ ì²´ ì •ë³´ì™€ ìŒì‹ì— ëŒ€í•œ ì¶”ê°€ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <div class="form-floating mb-4">
            <textarea class="form-control" name="user_text" placeholder="Leave a comment here" id="floatingTextarea2"
                      style="height: 100px"></textarea>
                <label for="floatingTextarea2">
                    ì˜ˆ: ë‚˜ì´ 25ì„¸, ë‚¨ì„±, í‚¤ 175cm, ëª¸ë¬´ê²Œ 70kg, í‰ì†Œ ìš´ë™ëŸ‰ ì¤‘ê°„, ì•„ì¹¨ì— ì‚¶ì€ ê³„ë€ 2ê°œ ë¨¹ìŒ...
                </label>
            </div>

            <!-- ì œì¶œ ë²„íŠ¼ -->
            <div class="d-grid gap-2 col-6 mx-auto mt-5">
                <a href="javascript:;" id="askBtn" type="button" class="btn btn-custom btn-lg rounded-pill fw-bold">
                    ğŸ½ï¸ ì˜¤ëŠ˜ì˜ ì‹ì‚¬ ì…ë ¥í•˜ê¸°
                </a>
{#                <input type="submit" value="ğŸ½ï¸ ì˜¤ëŠ˜ì˜ ì‹ì‚¬ ì…ë ¥í•˜ê¸°" class="btn btn-custom btn-lg rounded-pill fw-bold">#}
            </div>
        </form>

    </div>
{% endblock content %}

{% block script %}
    <script>
        const $chatLog      = document.getElementById("chagLog");
        const aiChatForm    =   '<div class="d-flex">'+
                                '    <div class="bg-light text-dark p-3 rounded-4 chatMsg">{msg}</div>'+
                                '</div>';
        const userChatForm  =   '<div class="d-flex justify-content-end">'+
                                '    <div class="bg-success text-white p-3 rounded-4 chatMsg">{msg}</div>'+
                                '</div>';
        const chatEle = function(format, msg) {
            const $template = document.createElement("template");
            $template.innerHTML = format.replace("{msg}", msg);
            return $template;
        }
        const appendChat = function(json) {
            let msgTmpl = chatEle(aiChatForm, json.answer);
            $chatLog.appendChild(msgTmpl.content.firstChild);
        }
    </script>
    <script>
        const f = document.askForm;
        const ask = function() {
            let formData = new FormData(f);
            let params = {
                method:"POST",
                cache:"no-cache",
                headers:{
                    "X-CSRFToken" :f.csrfmiddlewaretoken.value
                },
                body: formData
            };

            let msgTmpl = chatEle(userChatForm, f.user_text.value);
            $chatLog.appendChild(msgTmpl.content.firstChild);

            fetch("{% url "mainapp:chat" %}", params)
                .then(resp => resp.json())
                .then(appendChat);

            f.reset();
        }
        document.getElementById("askBtn").addEventListener("click", ask);
    </script>
{% endblock script %}